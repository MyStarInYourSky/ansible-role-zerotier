---
- name: Include vars of stuff.yaml into the 'stuff' variable (2.2).
  include_vars:
    file: osmap.yaml
    name: osmap
- name: Install ZeroTier (DEB)
  include_tasks: install_deb.yml
  when: ansible_facts['os_family'] == 'Debian'

- name: Install ZeroTier (RPM)
  include_tasks: install_rpm.yml
  when: ansible_facts['os_family'] == "RedHat"

- name: Wait for ZeroTier to generate identity
  wait_for:
    path: /var/lib/zerotier-one/identity.secret

- name: Build local config
  template:
    src: local.conf.j2
    dest: /var/lib/zerotier-one/local.conf
    owner: zerotier-one
    group: zerotier-one
    mode: 0644
  notify: Restart ZeroTier Service

- name: Setup ZeroTier Network 
  zerotier:
    name: "{{ item.key }}"
    apikey: "{{ item.value.apikey | default('') }}"
    nodename: "{{ item.value.nodename | default(inventory_hostname) }}"
    nodedescription: "{{ item.value.nodedescription | default('') }}"
    config: "{{ item.value.config | default('{}') }}"
    hidden: "{{ item.value.hidden | default(False) }}"
    joined: "{{ item.value.joined| default(True) }}"
  loop: "{{ lookup('dict', zerotier_networks, wantlist=True) }}"
  loop_control:
    label: "{{ item.key }}"
