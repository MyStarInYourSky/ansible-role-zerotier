version: v1.0
name: Test zerotier Ansible Role
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Test
    task:
      env_vars:
        - name: VAGRANT_VERSION
          value: "2.2.14"
        - name: VIRTUALBOX_MINOR_VERSION
          value: "6.1.22"
        - name: MOLECULE_DEBUG
          value: "0"
        - name: ANSIBLE_VEBOSITY
          value: "0"
      secrets:
        - name: ZEROTIER_QA_API_KEY
      prologue:
        commands:
          - checkout
          - export ZEROTIER_QA_NETWORK_KEY=$(curl -s -H "Authorization:bearer $ZEROTIER_QA_API_KEY" -H 'Content-Type:application/json' -d "{}" -X POST https://my.zerotier.com/api/network | jq -r ".id")
          - curl -s -H "Authorization:bearer $ZEROTIER_QA_API_KEY" -H 'Content-Type:application/json' -d '{"config":{"private":true,"ipAssignmentPools":[{"ipRangeStart":"192.168.55.1","ipRangeEnd":"192.168.55.254"}],"routes":[{"target":"192.168.55.0/24","via":null}],"v4AssignMode":{"zt":true}}}' -X POST "https://my.zerotier.com/api/network/$ZEROTIER_QA_NETWORK_KEY"
          - wget "https://releases.hashicorp.com/vagrant/${VAGRANT_VERSION}/vagrant_${VAGRANT_VERSION}_linux_amd64.zip"
          - unzip "vagrant_${VAGRANT_VERSION}_linux_amd64.zip"
          - rm "vagrant_${VAGRANT_VERSION}_linux_amd64.zip"
          - sudo mv vagrant /usr/local/bin/vagrant
          - sudo apt-get install qemu-kvm libvirt-daemon-system
          - pip3 install -r molecule/requirements.txt
          - export PATH=$PATH:/home/semaphore/.local/bin
          - j2 molecule/default/converge.yml.j2 > molecule/default/converge.yml
      epilogue:
        commands:
          - curl -s -H "Authorization:bearer $ZEROTIER_QA_API_KEY" -H 'Content-Type:application/json' -d "{}" -X DELETE "https://my.zerotier.com/api/network/$ZEROTIER_QA_NETWORK_KEY"
      jobs:
        - name: 'Test Playbook'
          commands:
            - molecule lint
            - molecule test