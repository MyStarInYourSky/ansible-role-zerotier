version: v1.0
name: Test zerotier Ansible Role
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Test
    task:
      env_vars:
        - name: VAGRANT_VERSION
          value: "2.2.14"
        - name: VIRTUALBOX_MINOR_VERSION
          value: "6.1.22"
        - name: MOLECULE_DEBUG
          value: "0"
        - name: ANSIBLE_VEBOSITY
          value: "0"
      secrets:
        - name: ZEROTIER_QA_API_KEY
      prologue:
        commands:
          - checkout
          - export ZEROTIER_QA_NETWORK_KEY=$(curl -s -H "Authorization:bearer $ZEROTIER_QA_API_KEY" -H 'Content-Type:application/json' -d "{}" -X POST https://my.zerotier.com/api/network | jq -r ".id")
          - curl -s -H "Authorization:bearer $ZEROTIER_QA_API_KEY" -H 'Content-Type:application/json' -d '{"config":{"private":true,"ipAssignmentPools":[{"ipRangeStart":"192.168.55.1","ipRangeEnd":"192.168.55.254"}],"routes":[{"target":"192.168.55.0/24","via":null}],"v4AssignMode":{"zt":true}}}' -X POST "https://my.zerotier.com/api/network/$ZEROTIER_QA_NETWORK_KEY"
          - curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          - sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          - sudo apt-get update
          - sudo apt-get -y install qemu libvirt-daemon-system libvirt-clients ebtables dnsmasq-base libxslt-dev libxml2-dev libvirt-dev zlib1g-dev ruby-dev libguestfs-tools vagrant
          - CONFIGURE_ARGS="with-libvirt-include=/usr/include/libvirt with-libvirt-lib=/usr/lib" vagrant plugin install vagrant-libvirt
          - pip3 install -r molecule/requirements.txt
          - export PATH=$PATH:/home/semaphore/.local/bin
          - j2 molecule/default/converge.yml.j2 > molecule/default/converge.yml
      epilogue:
        commands:
          - curl -s -H "Authorization:bearer $ZEROTIER_QA_API_KEY" -H 'Content-Type:application/json' -d "{}" -X DELETE "https://my.zerotier.com/api/network/$ZEROTIER_QA_NETWORK_KEY"
      jobs:
        - name: 'Test Playbook'
          commands:
            - molecule lint
            - molecule test