version: v1.0
name: Test zerotier Ansible Role
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Test
    task:
      env_vars:
        - name: VAGRANT_VERSION
          value: "2.2.14"
        - name: VIRTUALBOX_MINOR_VERSION
          value: "6.1.22"
        - name: MOLECULE_DEBUG
          value: "0"
        - name: ANSIBLE_VEBOSITY
          value: "0"
      secrets:
        - name: ZEROTIER_QA_API_KEY
        - name: DOCKER_HUB_ILOVEYATOO
      prologue:
        commands:
          - checkout
          - export ZEROTIER_QA_NETWORK_KEY=$(curl -s -H "Authorization:bearer $ZEROTIER_QA_API_KEY" -H 'Content-Type:application/json' -d "{}" -X POST https://my.zerotier.com/api/network | jq -r ".id")
          - curl -s -H "Authorization:bearer $ZEROTIER_QA_API_KEY" -H 'Content-Type:application/json' -d '{"config":{"private":true,"ipAssignmentPools":[{"ipRangeStart":"192.168.55.1","ipRangeEnd":"192.168.55.254"}],"routes":[{"target":"192.168.55.0/24","via":null}],"v4AssignMode":{"zt":true}}}' -X POST "https://my.zerotier.com/api/network/$ZEROTIER_QA_NETWORK_KEY"
          - echo "$DOCKER_HUB_PASS_ILOVEYATOO" | docker login --username "$DOCKER_HUB_USER_ILOVEYATOO" --password-stdin
          - docker run -it --rm -v /home/semaphore:/docker -v /var/run/libvirt/libvirt-sock:/var/run/libvirt/libvirt-sock -e ZEROTIER_QA_NETWORK_KEY=$ZEROTIER_QA_NETWORK_KEY -e ZEROTIER_QA_API_KEY=$ZEROTIER_QA_API_KEY iloveyatoo/semaphoreci-builder-vagrantlibvirt:latest /bin/bash -c "j2 /docker/ansible-role-zerotier/molecule/default/converge.yml.j2 > /docker/ansible-role-zerotier/molecule/default/converge.yml"
      epilogue:
        commands:
          - curl -s -H "Authorization:bearer $ZEROTIER_QA_API_KEY" -H 'Content-Type:application/json' -d "{}" -X DELETE "https://my.zerotier.com/api/network/$ZEROTIER_QA_NETWORK_KEY"
      jobs:
        - name: 'Test Playbook'
          commands:
            - docker run -it --rm -v /home/semaphore:/docker -v /var/run/libvirt/libvirt-sock:/var/run/libvirt/libvirt-sock iloveyatoo/semaphoreci-builder-vagrantlibvirt:latest /bin/bash -c "cd ansible-role-zerotier && molecule lint"
            - docker run -it --rm -v /home/semaphore:/docker -v /var/run/libvirt/libvirt-sock:/var/run/libvirt/libvirt-sock iloveyatoo/semaphoreci-builder-vagrantlibvirt:latest /bin/bash -c "cd ansible-role-zerotier && molecule test"