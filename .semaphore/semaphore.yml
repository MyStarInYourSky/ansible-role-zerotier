version: v1.0
name: Test zerotier Ansible Role
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Test
    task:
      env_vars:
        - name: VAGRANT_VERSION
          value: "2.2.14"
        - name: VIRTUALBOX_MINOR_VERSION
          value: "6.1.22"
      jobs:
        - name: 'Test Playbook'
          commands:
            - checkout
            - wget "https://releases.hashicorp.com/vagrant/${VAGRANT_VERSION}/vagrant_${VAGRANT_VERSION}_linux_amd64.zip"
            - unzip "vagrant_${VAGRANT_VERSION}_linux_amd64.zip"
            - rm "vagrant_${VAGRANT_VERSION}_linux_amd64.zip"
            - sudo mv vagrant /usr/local/bin/vagrant
            - wget https://download.virtualbox.org/virtualbox/${VIRTUALBOX_MINOR_VERSION}/$(curl -sL https://download.virtualbox.org/virtualbox/${VIRTUALBOX_MINOR_VERSION}/SHA256SUMS | awk -F'*' '{print $2}' | grep -i eoan)
            - sudo apt -y install ./virtualbox*deb
            - rm virtualbox*deb
            - wget https://download.virtualbox.org/virtualbox/${VIRTUALBOX_MINOR_VERSION}/Oracle_VM_VirtualBox_Extension_Pack-${VIRTUALBOX_MINOR_VERSION}.vbox-extpack
            - echo "y" | sudo VBoxManage extpack install --replace Oracle_VM_VirtualBox_Extension_Pack-${VIRTUALBOX_MINOR_VERSION}.vbox-extpack
            - rm Oracle_VM_VirtualBox_Extension_Pack-${VIRTUALBOX_MINOR_VERSION}.vbox-extpack
            - pip3 install molecule[lint] molecule-vagrant ansible==2.9.0 python-vagrant
            - export PATH=$PATH:/home/semaphore/.local/bin
            - molecule lint
            - molecule create